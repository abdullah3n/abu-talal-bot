<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¨ÙˆØª Ø£Ø¨Ùˆ Ø·Ù„Ø§Ù„</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #060a0f;
    --surface: #0d1520;
    --border: #1a2840;
    --green: #00ff88;
    --red: #ff3355;
    --yellow: #ffcc00;
    --blue: #0088ff;
    --text: #c8d8e8;
    --dim: #4a6080;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Tajawal', sans-serif;
    min-height: 100vh;
    padding: 20px;
    background-image: 
      radial-gradient(ellipse at 20% 20%, rgba(0,136,255,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(0,255,136,0.03) 0%, transparent 60%);
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
  }
  .logo { font-size: 20px; font-weight: 900; color: white; }
  .logo span { color: var(--green); }
  .status-badge {
    display: flex; align-items: center; gap: 8px;
    background: rgba(0,255,136,0.08);
    border: 1px solid rgba(0,255,136,0.2);
    padding: 6px 14px; border-radius: 100px;
    font-size: 12px; font-weight: 700; color: var(--green);
  }
  .dot { width: 7px; height: 7px; background: var(--green); border-radius: 50%; animation: pulse 1.5s infinite; }
  .dot.offline { background: var(--red); animation: none; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.8)} }

  /* ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ */
  .mode-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }
  .mode-label { font-size: 12px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--dim); }
  .mode-buttons { display: flex; gap: 8px; flex: 1; }
  .mode-btn {
    flex: 1; padding: 10px; border-radius: 8px;
    border: 1px solid var(--border);
    background: transparent; color: var(--dim);
    font-family: 'Tajawal', sans-serif;
    font-size: 13px; font-weight: 700;
    cursor: pointer; transition: all 0.2s;
  }
  .mode-btn:hover { border-color: #2a3850; color: var(--text); }
  .mode-btn.active-alert { background: rgba(0,136,255,0.15); border-color: var(--blue); color: var(--blue); }
  .mode-btn.active-hybrid { background: rgba(255,204,0,0.15); border-color: var(--yellow); color: var(--yellow); }
  .mode-btn.active-auto { background: rgba(0,255,136,0.15); border-color: var(--green); color: var(--green); }

  /* Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ */
  .server-banner {
    background: rgba(255,51,85,0.08);
    border: 1px solid rgba(255,51,85,0.2);
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 20px;
    color: var(--red);
    font-size: 13px;
    font-weight: 700;
    display: none;
    align-items: center;
    gap: 8px;
  }

  /* Ø§Ù„Ø¹Ø¯Ø§Ø¯ */
  .market-banner {
    display: flex; align-items: center; justify-content: center; gap: 12px;
    background: rgba(255,204,0,0.06); border: 1px solid rgba(255,204,0,0.15);
    border-radius: 10px; padding: 14px; margin-bottom: 20px;
    color: var(--yellow); font-weight: 700; font-size: 13px;
    flex-wrap: wrap; text-align: center;
  }
  .market-banner.open { background: rgba(0,255,136,0.06); border-color: rgba(0,255,136,0.2); color: var(--green); }
  .countdown { font-family: 'IBM Plex Mono', monospace; font-size: 20px; font-weight: 600; color: var(--yellow); }

  /* Ø§Ù„ÙƒØ±ÙˆØª */
  .grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; margin-bottom: 20px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 18px; position: relative; overflow: hidden; }
  .card::before { content:''; position:absolute; top:0;left:0;right:0; height:2px; }
  .card.green::before{background:var(--green)} .card.red::before{background:var(--red)}
  .card.yellow::before{background:var(--yellow)} .card.blue::before{background:var(--blue)}
  .card-label { font-size:11px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--dim); margin-bottom:8px; }
  .card-value { font-family:'IBM Plex Mono',monospace; font-size:26px; font-weight:600; color:white; }
  .card-value.green{color:var(--green)} .card-value.yellow{color:var(--yellow)}
  .card-sub { font-size:11px; color:var(--dim); margin-top:4px; }

  /* Pending */
  .pending-section { margin-bottom: 20px; }
  .pending-card {
    background: rgba(255,204,0,0.06);
    border: 1px solid rgba(255,204,0,0.3);
    border-radius: 10px; padding: 16px;
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px; flex-wrap: wrap; gap: 12px;
  }
  .pending-info { font-size: 14px; font-weight: 700; }
  .pending-info span { font-family:'IBM Plex Mono',monospace; color: var(--yellow); }
  .pending-actions { display: flex; gap: 8px; }
  .approve-btn {
    background: rgba(0,255,136,0.15); border: 1px solid var(--green);
    color: var(--green); padding: 8px 18px; border-radius: 8px;
    font-family:'Tajawal',sans-serif; font-size:13px; font-weight:700;
    cursor: pointer; transition: all 0.2s;
  }
  .approve-btn:hover { background: rgba(0,255,136,0.25); }
  .reject-btn {
    background: rgba(255,51,85,0.1); border: 1px solid var(--red);
    color: var(--red); padding: 8px 18px; border-radius: 8px;
    font-family:'Tajawal',sans-serif; font-size:13px; font-weight:700;
    cursor: pointer; transition: all 0.2s;
  }

  /* Ø§Ù„Ø£Ø³Ù‡Ù… */
  .section-title { font-size:12px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); margin-bottom:14px; }
  .stocks-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; margin-bottom:20px; }
  .stock-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:14px; transition:all .2s; }
  .stock-card.active { border-color:rgba(0,255,136,.4); background:rgba(0,255,136,.04); }
  .stock-symbol { font-family:'IBM Plex Mono',monospace; font-size:15px; font-weight:600; color:white; margin-bottom:8px; }
  .stock-card.active .stock-symbol{color:var(--green)}
  .ind-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .ind-label{font-size:10px;color:var(--dim)} 
  .ind-val{font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;color:var(--text)}
  .ind-val.good{color:var(--green)} .ind-val.bad{color:var(--red)} .ind-val.warn{color:var(--yellow)}
  .progress-bar{width:100%;height:2px;background:var(--border);border-radius:2px;margin:6px 0;overflow:hidden}
  .progress-fill{height:100%;border-radius:2px;transition:width 1s}
  .stock-status{margin-top:8px;font-size:11px;font-weight:700}

  /* Ø§Ù„Ù„ÙˆØ¬ */
  .log-wrap { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:18px; margin-bottom:20px; }
  .log-entry { display:flex; gap:12px; padding:8px 0; border-bottom:1px solid rgba(26,40,64,.4); font-size:12px; animation:fadeIn .3s; }
  .log-entry:last-child{border-bottom:none}
  @keyframes fadeIn{from{opacity:0;transform:translateX(6px)}to{opacity:1;transform:translateX(0)}}
  .log-time{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--dim);white-space:nowrap;padding-top:1px}
  .log-icon{width:18px;text-align:center}
  .log-msg{color:var(--text);flex:1}

  .footer{text-align:center;color:var(--dim);font-size:11px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}

  @media(max-width:800px){
    .grid{grid-template-columns:repeat(2,1fr)}
    .stocks-grid{grid-template-columns:repeat(2,1fr)}
    .mode-buttons{flex-direction:row}
  }
</style>
</head>
<body>

<header>
  <div class="logo">Ø¨ÙˆØª <span>Ø£Ø¨Ùˆ Ø·Ù„Ø§Ù„</span></div>
  <div class="status-badge">
    <div class="dot" id="status-dot"></div>
    <span id="status-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
  </div>
</header>

<!-- Ø¥Ø´Ø¹Ø§Ø± Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ -->
<div class="server-banner" id="server-banner">
  âš ï¸ Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ØªØµÙ„ â€” ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ùƒ
</div>

<!-- ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ -->
<div class="mode-section">
  <div class="mode-label">âš™ï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„</div>
  <div class="mode-buttons">
    <button class="mode-btn" id="btn-alert" onclick="setMode('alert')">ğŸ”” Alert</button>
    <button class="mode-btn" id="btn-hybrid" onclick="setMode('hybrid')">â³ Hybrid</button>
    <button class="mode-btn" id="btn-auto" onclick="setMode('auto')">ğŸ¤– Auto</button>
  </div>
</div>

<!-- Ø§Ù„Ø¹Ø¯Ø§Ø¯ -->
<div class="market-banner" id="market-banner">
  â° Ø§Ù„Ø³ÙˆÙ‚ Ù…ØºÙ„Ù‚ | ÙŠÙØªØ­ Ø§Ù„Ø³Ø§Ø¹Ø© 4:30 Ù…Ø³Ø§Ø¡Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø±ÙŠØ§Ø¶ |
  <span class="countdown" id="countdown">--:--:--</span>
</div>

<!-- Ø§Ù„ÙƒØ±ÙˆØª -->
<div class="grid">
  <div class="card green">
    <div class="card-label">Ø±ØµÙŠØ¯ Ø§Ù„Ø¨ÙˆØª</div>
    <div class="card-value green" id="balance">$100,000</div>
    <div class="card-sub">Paper Trading</div>
  </div>
  <div class="card blue">
    <div class="card-label">Ø£Ø³Ù‡Ù… ØªØ­Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</div>
    <div class="card-value" id="watchlist-count">5</div>
    <div class="card-sub">AMC SOFI PLUG MULN SNDL</div>
  </div>
  <div class="card yellow">
    <div class="card-label">ØµÙÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø©</div>
    <div class="card-value yellow" id="positions-count">0</div>
    <div class="card-sub" id="positions-sub">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª</div>
  </div>
  <div class="card red">
    <div class="card-label">Ø¢Ø®Ø± ÙØ­Øµ</div>
    <div class="card-value" style="font-size:18px" id="last-scan">--:--</div>
    <div class="card-sub">ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©</div>
  </div>
</div>

<!-- Pending Hybrid -->
<div id="pending-section" style="display:none">
  <div class="section-title">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚ØªÙƒ</div>
  <div id="pending-cards"></div>
</div>

<!-- Ø§Ù„Ø£Ø³Ù‡Ù… -->
<div class="section-title">Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª</div>
<div class="stocks-grid" id="stocks-grid"></div>

<!-- Ø§Ù„Ù„ÙˆØ¬ -->
<div class="section-title">Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙˆØª</div>
<div class="log-wrap">
  <div id="log-entries"><div style="color:var(--dim);text-align:center;padding:20px">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨ÙˆØª...</div></div>
</div>

<div class="footer">Ø¨ÙˆØª Ø£Ø¨Ùˆ Ø·Ù„Ø§Ù„ â€” Paper Trading â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…ÙˆØ§Ù„ Ø­Ù‚ÙŠÙ‚ÙŠØ©</div>

<script>
// Ø¶Ø¹ Ù‡Ù†Ø§ IP Ø§Ù„Ù…Ø§Ùƒ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
const SERVER = "http://192.168.100.106:8765";

let connected = false;

async function fetchState() {
  try {
    const res = await fetch(SERVER, { cache: 'no-store' });
    const data = await res.json();
    connected = true;
    updateUI(data);
  } catch(e) {
    connected = false;
    document.getElementById('server-banner').style.display = 'flex';
    document.getElementById('status-dot').className = 'dot offline';
    document.getElementById('status-text').textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
  }
}

async function setMode(mode) {
  try {
    await fetch(SERVER, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({action:'set_mode', mode})
    });
    fetchState();
  } catch(e) {}
}

async function approve(symbol) {
  await fetch(SERVER, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({action:'approve', symbol})
  });
  fetchState();
}

async function reject(symbol) {
  await fetch(SERVER, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({action:'reject', symbol})
  });
  fetchState();
}

function updateUI(data) {
  document.getElementById('server-banner').style.display = 'none';
  document.getElementById('status-dot').className = 'dot';
  document.getElementById('status-text').textContent = 'Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„';
  document.getElementById('last-scan').textContent = data.last_scan || '--';
  document.getElementById('positions-count').textContent = Object.keys(data.positions || {}).length;

  // ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„
  ['alert','hybrid','auto'].forEach(m => {
    const btn = document.getElementById('btn-'+m);
    btn.className = 'mode-btn' + (data.mode === m ? ' active-'+m : '');
  });

  // Pending
  const pending = data.pending || {};
  const pendingKeys = Object.keys(pending);
  const pendingSection = document.getElementById('pending-section');
  if (pendingKeys.length > 0 && data.mode === 'hybrid') {
    pendingSection.style.display = 'block';
    document.getElementById('pending-cards').innerHTML = pendingKeys.map(sym => `
      <div class="pending-card">
        <div class="pending-info">ğŸš€ <span>${sym}</span> â€” Ø´Ø±ÙˆØ· Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…ÙƒØªÙ…Ù„Ø©! Ù‡Ù„ ØªÙ†ÙØ° Ø§Ù„ØµÙÙ‚Ø©ØŸ</div>
        <div class="pending-actions">
          <button class="approve-btn" onclick="approve('${sym}')">âœ… Ù…ÙˆØ§ÙÙ‚</button>
          <button class="reject-btn" onclick="reject('${sym}')">âŒ Ø±ÙØ¶</button>
        </div>
      </div>
    `).join('');
  } else {
    pendingSection.style.display = 'none';
  }

  // Ø§Ù„Ø£Ø³Ù‡Ù…
  const stocks = data.stocks || {};
  const grid = document.getElementById('stocks-grid');
  if (Object.keys(stocks).length > 0) {
    grid.innerHTML = Object.entries(stocks).map(([sym, d]) => `
      <div class="stock-card ${d.passed ? 'active' : ''}">
        <div class="stock-symbol">${sym} ${d.passed ? 'ğŸš€' : ''}</div>
        <div class="ind-row"><span class="ind-label">Ø§Ù„Ø³Ø¹Ø±</span><span class="ind-val">$${d.price}</span></div>
        <div class="ind-row"><span class="ind-label">VWAP</span><span class="ind-val ${d.price > d.vwap ? 'good':'bad'}">${d.price > d.vwap ? 'â†‘':'â†“'} $${d.vwap}</span></div>
        <div class="ind-row"><span class="ind-label">RSI</span><span class="ind-val ${d.rsi>55&&d.rsi<90?'good':'bad'}">${d.rsi}</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${d.rsi}%;background:${d.rsi>55&&d.rsi<90?'var(--green)':'var(--red)'}"></div></div>
        <div class="ind-row"><span class="ind-label">CCI</span><span class="ind-val ${d.cci>100?'good':'warn'}">${d.cci}</span></div>
        <div class="ind-row"><span class="ind-label">RelVol</span><span class="ind-val ${d.rel_vol>2?'good':'bad'}">${d.rel_vol}x</span></div>
        <div class="ind-row"><span class="ind-label">EMA9>20</span><span class="ind-val ${d.ema9>d.ema20?'good':'bad'}">${d.ema9>d.ema20?'âœ“':'âœ—'}</span></div>
        <div class="stock-status" style="color:${d.passed?'var(--green)':'var(--dim)'}">
          ${d.passed ? 'âœ… Ø´Ø±ÙˆØ· Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…ÙƒØªÙ…Ù„Ø©' : (d.fails && d.fails.length > 0 ? 'âŒ '+d.fails[0] : 'â³ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±')}
        </div>
      </div>
    `).join('');
  }

  // Ø§Ù„Ù„ÙˆØ¬
  const logs = data.logs || [];
  document.getElementById('log-entries').innerHTML = logs.length > 0
    ? logs.map(l => `
        <div class="log-entry">
          <span class="log-time">${l.time}</span>
          <span class="log-icon">${l.icon}</span>
          <span class="log-msg">${l.msg}</span>
        </div>
      `).join('')
    : '<div style="color:var(--dim);text-align:center;padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</div>';
}

// Ø§Ù„Ø¹Ø¯Ø§Ø¯
function updateCountdown() {
  const now = new Date();
  const etOffset = -5 * 60;
  const nowET = new Date(now.getTime() + (etOffset - now.getTimezoneOffset()) * 60000);
  let open = new Date(nowET);
  open.setHours(9, 30, 0, 0);
  const banner = document.getElementById('market-banner');
  if (nowET.getHours() >= 9 && nowET.getHours() < 16) {
    banner.className = 'market-banner open';
    banner.innerHTML = 'ğŸŸ¢ Ø§Ù„Ø³ÙˆÙ‚ Ù…ÙØªÙˆØ­ Ø§Ù„Ø¢Ù† â€” Ø§Ù„Ø¨ÙˆØª ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ±Øµ';
    return;
  }
  if (nowET >= open) open.setDate(open.getDate() + 1);
  const diff = open - nowET;
  const h = Math.floor(diff/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const s = Math.floor((diff%60000)/1000);
  document.getElementById('countdown').textContent =
    `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
setInterval(fetchState, 5000);
setInterval(updateCountdown, 1000);
fetchState();
updateCountdown();
</script>
</body>
</html>
